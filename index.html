<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tom the AI</title>
<style>
:root {
  --bg: #eef1f6;
  --card: #ffffff;
  --text: #111;
  --muted: #6c7a92;
  --accent: #4e7dff;
  --user: #dce7ff;
  --ai: #f2f4f7;
  --code: #0f4d0f;
}
[data-theme="dark"] {
  --bg: #0d1117;
  --card: #161b22;
  --text: #e6eef8;
  --muted: #9fb0c9;
  --accent: #4ea1ff;
  --user: #0b4a87;
  --ai: #111b27;
  --code: #1aff1a;
}

html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, sans-serif; }
.container { max-width: 880px; margin: 20px auto; padding: 16px; }
header { display: flex; align-items: flex-start; gap: 14px; margin-bottom: 12px; position: relative; }
.logoContainer { display: flex; flex-direction: column; align-items: center; gap: 6px; }
.logo { width: 56px; height: 56px; background: linear-gradient(135deg,#4e7dff,#8b5cff); border-radius: 14px; display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:800;box-shadow:0 6px 18px rgba(0,0,0,0.15);}
h1 {margin:0;font-size:22px; display:inline;}
.controls {margin-left:auto;display:flex;align-items:center;gap:10px;}
label { color: var(--muted); font-size: 13px; }

#reloadBtn {
  padding: 6px 12px;
  border-radius: 10px;
  border: none;
  background: #4e7dff;
  color: white;
  cursor: pointer;
  font-size: 13px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.1);
}

#chat { background: var(--card); border-radius: 14px; height: 65vh; overflow-y: auto; padding: 16px; margin-top: 8px; box-shadow: 0 8px 22px rgba(0,0,0,0.09);}
.msg { display:flex;margin:10px 0; }
.bubble { max-width:75%; padding:13px 16px; border-radius:14px; line-height:1.4; box-shadow:0 3px 8px rgba(0,0,0,0.06);}
.user { margin-left:auto; background: var(--user); border-bottom-right-radius: 6px;}
.ai { margin-right:auto; background: var(--ai); border-bottom-left-radius: 6px;}
.inputRow { display:flex;gap:10px;margin-top:12px; flex-wrap:wrap;}
input[type="text"] { flex:1;padding:13px;border-radius:12px;border:1px solid #d0d7de;background:transparent;color:var(--text); font-size:15px;}
select { padding:12px; border-radius:12px; border:1px solid #d0d7de; background:var(--card); font-size:14px; cursor:pointer;}
button { padding:12px 15px; border-radius:12px; border:none; background:var(--accent); color:white; cursor:pointer; font-size:15px;}
button#clearBtn { background:#ff6666; }
button#clearAllBtn { background:#ff5555; }

.typing .dot { height:7px;width:7px;background: var(--muted);border-radius:50%;display:inline-block;margin-right:4px;opacity:0;animation:blink 1.2s infinite;}
.typing .dot:nth-child(2){ animation-delay: .15s }
.typing .dot:nth-child(3){ animation-delay: .3s }
@keyframes blink {0%{opacity:0}40%{opacity:1}80%{opacity:0}100%{opacity:0}}

.error { color: #ff6666; margin-top:8px;}
.codeBox { background:#0f0f0f; color:var(--code); padding:10px; border-radius:8px; font-family: monospace; white-space: pre-wrap; margin-top:6px; }

/* FULLSCREEN IFRAME STYLES */
#aiFrame {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  border: none;
  z-index: 9998;
  display: none;
  background: var(--bg);
}

/* BACK BUTTON FOR IFRAME */
#closeFrameBtn {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
  display: none;
  padding: 10px 20px;
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 30px;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

body.galaxy {
  background: url('https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
  background-size: cover;
}
</style>
</head>
<body>

<button id="closeFrameBtn">‚Üê Go Back to Tom The AI</button>
<iframe id="aiFrame" src="" scrolling="yes"></iframe>

<div class="container">
<header>
  <div class="logoContainer">
    <button id="reloadBtn">Reload Page</button>
    <div class="logo">T</div>
  </div>
  <div>
    <h1>Tom the AI</h1>
    <div class="muted">Chat with Tom anytime</div>
  </div>
  <div class="controls">
    <label>Dark</label>
    <input id="darkToggle" type="checkbox" />
    <label>Galaxy</label>
    <input id="galaxyToggle" type="checkbox" />
  </div>
</header>

<div style="margin-bottom:10px;">
  <label for="persona">Select Tom's type:</label>
  <select id="persona">
    <option value="human">Tom the Human</option>
    <option value="coder">Tom the Coder</option>
    <option value="researcher">Tom the Researcher</option>
    <option value="roaster">Tom the Roaster</option>
    <option value="idiot">Tom the Idiot</option>
    <option value="annoying">Tom the Annoying</option>
    <option value="asian">Tom the Asian</option>
    <option value="obese">Tom the Obese</option>
    <option value="depressed">Tom the Depressed</option>
    <option value="gamer">Tom the Gamer</option>
    <option value="meme">Tom the Internet-Meme</option>
    <option value="bragger">Tom the Bragger</option>
    <option value="video_link">Tom the free Video/Image Ai üîó</option>
  </select>
</div>

<div id="chat"></div>

<div class="inputRow">
  <input id="msg" type="text" placeholder="Ask Tom something..." />
  <button id="sendBtn">Send</button>
  <button id="clearBtn">Clear Chat</button>
  <button id="clearAllBtn">Clear All Chat History</button>
</div>

<div id="error" class="error"></div>
</div>

<script>
const APP_ID = "aZG4Su7oUextVdALeYgYE14Y7Yc5PrLEcUSzwXJp";
const REST_KEY = "6X6kPwMLSjaVADUiwPjXMinr5PdHPJ1exWVzlWbf";
const BACKEND_URL = "https://parseapi.back4app.com/functions/askAI";

const chatDiv = document.getElementById("chat");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const clearAllBtn = document.getElementById("clearAllBtn");
const errorDiv = document.getElementById("error");
const darkToggle = document.getElementById("darkToggle");
const galaxyToggle = document.getElementById("galaxyToggle");
const personaSelect = document.getElementById("persona");
const reloadBtn = document.getElementById("reloadBtn");
const aiFrame = document.getElementById("aiFrame");
const closeFrameBtn = document.getElementById("closeFrameBtn");

// URLs
const DESKTOP_VIDEO_URL = "https://math12393.codeberg.page/Tom-the-free-video-and-image-AI/";
const MOBILE_VIDEO_URL = "https://math12393.codeberg.page/Tom-the-free-video-and-image-AI-MOBILE/";

reloadBtn.onclick = () => location.reload();

const savedTheme = localStorage.getItem("theme") || "light";
document.documentElement.setAttribute("data-theme", savedTheme);
darkToggle.checked = savedTheme==="dark";
darkToggle.onclick = () => {
  const theme = darkToggle.checked ? "dark" : "light";
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);
};

galaxyToggle.checked = localStorage.getItem("galaxy")==="true";
if(galaxyToggle.checked) document.body.classList.add("galaxy");
galaxyToggle.onclick = () => {
  if(galaxyToggle.checked){
    document.body.classList.add("galaxy");
    localStorage.setItem("galaxy", "true");
  } else {
    document.body.classList.remove("galaxy");
    localStorage.setItem("galaxy", "false");
  }
};

const userKey = localStorage.getItem("userKey") || ("u_"+Math.random().toString(36).slice(2,9));
localStorage.setItem("userKey", userKey);

function loadLocalHistory(){
  const history = JSON.parse(localStorage.getItem("chat_history") || "[]");
  chatDiv.innerHTML = "";
  history.forEach(m=>{
    if(m.persona === personaSelect.value) addMessageToUI(m.from, m.text, false, m.persona);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function addMessageToUI(from, text, save=true, persona=personaSelect.value){
  const m = document.createElement("div");
  m.className = "msg";

  const b = document.createElement("div");
  b.className = "bubble " + (from==="user" ? "user" : "ai");

  if(persona === "coder" && from === "ai"){
    const codeBox = document.createElement("div");
    codeBox.className = "codeBox";
    codeBox.textContent = text;
    b.appendChild(codeBox);
  } 
  else if(persona === "human" && from === "ai"){
    b.innerHTML = `<strong>Human Tom:</strong> ${text}`;
  } 
  else if(persona === "researcher" && from === "ai"){
    b.innerHTML = `<strong>Researcher Tom:</strong><br>${text}`;
  } 
  else if(persona === "roaster" && from === "ai"){
    b.innerHTML = `<strong>Roaster Tom:</strong> ${text}`;
  }
  else if(persona === "idiot" && from === "ai"){
    b.innerHTML = `<strong>Idiot Tom:</strong> ${text}`;
  }
  else if(persona === "annoying" && from === "ai"){
    b.innerHTML = `<strong>annoying Tom:</strong> ${text}`;
  }
  else if(persona === "asian" && from === "ai"){
    b.innerHTML = `<strong>Asian Tom:</strong> ${text}`;
  }
  else if(persona === "obese" && from === "ai"){
    b.innerHTML = `<strong>Obese Tom:</strong> ${text}`;
  }
  else if(persona === "depressed" && from === "ai"){
    b.innerHTML = `<strong>Depressed Tom:</strong> ${text}`;
  }
  else if(persona === "meme" && from === "ai"){
    b.innerHTML = `<strong>Internet-Meme Tom:</strong> ${text}`;
  }
  else if(persona === "gamer" && from === "ai"){
    b.innerHTML = `<strong>Gamer Tom:</strong> ${text}`;
  }
  else if(persona === "bragger" && from === "ai"){
    b.innerHTML = `<strong>Bragger Tom:</strong> ${text}`;
  }
  else {
    b.innerHTML = text;
  }

  m.appendChild(b);
  chatDiv.appendChild(m);

  if(save){
    const h = JSON.parse(localStorage.getItem("chat_history") || "[]");
    h.push({from, text, time: Date.now(), persona});
    localStorage.setItem("chat_history", JSON.stringify(h));
  }

  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function showTyping(){
  const m = document.createElement("div");
  m.className="msg";
  m.id="typingRow";
  m.innerHTML=`
    <div class="bubble ai">
    <strong>Tom is typing</strong>
    <span class="typing">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </span>
    </div>`;
  chatDiv.appendChild(m);
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function hideTyping(){
  const t = document.getElementById("typingRow");
  if(t) t.remove();
}

sendBtn.onclick = sendMessage;

msgInput.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){
    sendMessage();
    e.preventDefault();
  }
});

async function sendMessage(){
  const text = msgInput.value.trim();
  if(!text) return;

  const persona = personaSelect.value;
  if(persona === "video_link") return; 

  addMessageToUI("user", text);
  msgInput.value = "";
  errorDiv.textContent = "";
  showTyping();

  try{
    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: {
        "X-Parse-Application-Id": APP_ID,
        "X-Parse-REST-API-Key": REST_KEY,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        prompt: text,
        persona: persona,
        userKey: userKey
      })
    });

    if(!res.ok) throw new Error(`Server error: ${res.status}`);

    const data = await res.json();
    hideTyping();

    const reply = data.result?.choices?.[0]?.message?.content || "Tom didn't understand.";
    addMessageToUI("ai", reply, true, persona);

  } catch(err){
    hideTyping();
    errorDiv.textContent = "Error: " + err.message;
  }
}

clearBtn.onclick = () => {
  if(confirm("Clear only this persona's chat?")){
    const history = JSON.parse(localStorage.getItem("chat_history") || "[]");
    const filtered = history.filter(m => m.persona !== personaSelect.value);
    localStorage.setItem("chat_history", JSON.stringify(filtered));
    loadLocalHistory();
  }
};

clearAllBtn.onclick = () => {
  if(confirm("Clear ALL chat history?")){
    localStorage.removeItem("chat_history");
    chatDiv.innerHTML = "";
  }
};

/* ===== DEVICE DETECTION LOGIC ===== */
function isMobileDevice() {
  return /Android|iPhone|Samsung|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

/* ===== PERSONA LOGIC ===== */
personaSelect.onchange = () => {
  if(personaSelect.value === "video_link") {
    // Detect mobile and set source
    if(isMobileDevice()) {
        aiFrame.src = MOBILE_VIDEO_URL;
    } else {
        aiFrame.src = DESKTOP_VIDEO_URL;
    }
    
    aiFrame.style.display = "block";
    closeFrameBtn.style.display = "block";
  } else {
    aiFrame.style.display = "none";
    closeFrameBtn.style.display = "none";
    aiFrame.src = ""; // Clear src to stop video/iframe in background
    loadLocalHistory();
  }
};

/* ===== BACK BUTTON LOGIC ===== */
closeFrameBtn.onclick = () => {
  personaSelect.value = "human";
  aiFrame.style.display = "none";
  closeFrameBtn.style.display = "none";
  aiFrame.src = ""; 
  loadLocalHistory();
};

loadLocalHistory();
</script>
</body>
</html>
